import{j as e}from"./vendor-markdown-Dek94WS0.js";import{r as y}from"./vendor-react-V04_Axys.js";import{r as Qe,g as Xe,m as Ze,i as et}from"./workflowChat-DQqFLrZg.js";import{a as Z,u as Ie,W as Pe,g as tt}from"./message-components-D3rPBq8S.js";import"./input.js";import"./App-DuEmect-.js";function st(l,o){try{if(!l)return console.error("Invalid prompt_output: ",l),l;for(const r of o){if(!l[r.nodeId]){console.error(`Node with ID ${r.nodeId} not found`);continue}if(!l[r.nodeId].inputs){console.error(`Inputs not found for node with ID ${r.nodeId}`);continue}l[r.nodeId].inputs[r.paramName]=r.paramValue}return l}catch(r){return console.error("Error updating prompt:",r),l}}async function rt(l){const o=await Z.graphToPrompt(),r=st(o.output,l);console.log("queuePrompt updated_prompt:",r);const x={prompt:r,client_id:Z.api.clientId,extra_data:{extra_pageinfo:{workflow:o.workflow}}};console.debug("queuePrompt request_body.prompt:",r);const g=await Qe(x);return console.debug("queuePrompt response:",g),g}function Me(l){const o=document.createElement("canvas"),r=o.getContext("2d");if(o.width=512,o.height=512,r){r.fillStyle="#f8d7da",r.fillRect(0,0,o.width,o.height),r.strokeStyle="#dc3545",r.lineWidth=4,r.strokeRect(10,10,o.width-20,o.height-20),r.fillStyle="#dc3545",r.beginPath(),r.arc(o.width/2,150,50,0,2*Math.PI),r.fill(),r.fillStyle="white",r.font="bold 80px Arial",r.textAlign="center",r.textBaseline="middle",r.fillText("!",o.width/2,150),r.fillStyle="#721c24",r.font="20px Arial",r.textAlign="center",r.textBaseline="middle";const x=o.width-60,g=30,u=l.split(" ");let c="",m=250;for(let b=0;b<u.length;b++){const P=c+u[b]+" ";r.measureText(P).width>x&&b>0?(r.fillText(c,o.width/2,m),c=u[b]+" ",m+=g):c=P}r.fillText(c,o.width/2,m)}return o.toDataURL("image/png")}async function nt(l){try{if(!l||l==="")return console.log("No prompt ID provided"),{1:[Me("Fail to generate prompt ID")]};const o=await Xe(l);if(!o||!o[l])return console.log("Not finished for prompt ID:",l),{};const r=o[l];if(r.status&&r.status.status_str==="error"){console.error("Error for prompt ID:",l);const g=r.status.messages;if(g&&g.length>0){const u=g[g.length-1];if(u&&u.length>0){const c=u[0];return{1:[Me(c)]}}}}const x={};if(r.outputs)for(const g in r.outputs){const u=r.outputs[g];if(u&&u.images){x[g]=[];for(const c of u.images)if(c&&c.filename&&c.type){const m=Z.graph._nodes_by_id[g].imgs[0].currentSrc.split("?")[0];x[g].push(m+"?filename="+encodeURIComponent(c.filename)+"&type="+encodeURIComponent(c.type)+(c.subfolder?"&subfolder="+encodeURIComponent(c.subfolder):""))}console.log("outputImages for nodeId:",g,x[g])}}return x}catch(o){throw console.error("Error getting output images from prompt:",o),o}}function ot(){const l=Object.values(Z.graph._nodes_by_id),o=[],r=[];for(const x of l)x.type==="SaveImage"?o.push(x.id):x.type==="PreviewImage"&&r.push(x.id);if(console.log("saveNodeIds:",o),console.log("previewNodeIds:",r),o.length===0&&r.length===0)throw new Error("No SaveImage or PreviewImage node found, please add one to the graph");return o.length===1?o[0]:o.length==0&&r.length===1?r[0]:null}async function at(l,o){const r=await nt(l);return Object.keys(r).length===0?null:r[o.toString()]&&r[o.toString()].length>0?r[o.toString()][0]:null}const lt=({selectedNodes:l,handleParamSelect:o,selectedParams:r,handleNext:x,handleClose:g})=>{const c=l.flatMap(m=>(m.widgets||[]).map(b=>b.name)).some(m=>r[m]===!0);return e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4",children:[e.jsxs("div",{className:"mb-4 border-b pb-2 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-medium text-gray-800",children:"Select Parameters for Testing"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Choose the parameters you want to include in your batch test"})]}),e.jsx("button",{className:"text-gray-400 hover:text-gray-600",onClick:g,children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),l.map((m,b)=>{const P=m.title||"Unknown Node",L=m.widgets||[];return e.jsxs("div",{className:"border rounded-md mb-4 overflow-hidden",children:[e.jsx("div",{className:"bg-gray-50 px-3 py-2 text-sm font-medium text-gray-700 border-b",children:P}),e.jsx("div",{className:"p-4 space-y-3",children:e.jsx("div",{className:"flex items-center gap-3 flex-wrap",children:L.map(($,_)=>{const F=$.name;return e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`w-5 h-5 rounded-full border flex items-center justify-center ${r[F]?"border-red-500 bg-red-100":"border-gray-300"}`,onClick:A=>o(F,A),children:r[F]&&e.jsx("div",{className:"w-3 h-3 rounded-full bg-red-500"})}),e.jsx("span",{className:"ml-2 text-gray-700 text-xs",children:F})]},`widget-${_}`)})})})]},`node-${b}`)}),e.jsx("div",{className:"mt-6 flex justify-center",children:e.jsx("button",{onClick:m=>x(m),disabled:!c,className:`px-3 py-1.5 text-xs ${c?"bg-pink-200 text-pink-700 hover:bg-pink-300":"bg-gray-200 text-gray-500 cursor-not-allowed"} rounded-md transition-colors`,children:"Next"})})]})},it=({selectedNodes:l,paramTestValues:o,selectedParams:r,updateParamTestValues:x,toggleDropdown:g,openDropdowns:u,handleTestValueSelect:c,searchTerms:m,handleSearch:b,handleSelectAll:P,handleNext:L,handlePrevious:$,handleClose:_,inputValues:F,setInputValues:A,textInputs:T,handleTextInputChange:D,handleAddTextInput:R,handleRemoveTextInput:v,openAiWritingModal:w})=>{const S=(k,M,q,J=0)=>{if(k=isNaN(k)?0:k,M=isNaN(M)?100:M,q=isNaN(q)||q<=0?1:q,M<k&&(M=k),Math.floor((M-k)/q)+1<=1)return[k];const I=[];let Y=k;for(;Y<=M;){const d=Math.pow(10,J),V=Math.round(Y*d)/d;I.push(V),Y+=q}return I};return y.useEffect(()=>{!l||l.length===0||l.forEach(k=>{const M=k.id.toString(),q=k.widgets||{};Object.values(q).forEach(h=>{const I=h.name;if(!r[I])return;if(!(o[M]?.[I]?.length>0)&&h.type==="number"){const d=h.options?.min||0,V=h.options?.max||100,O=(h.options?.step||10)/10,C=h.options?.precision||0,B=S(d,V,O,C);if(B.length>0){x(M,I,B);const H=`${M}_${I}`;A(p=>({...p,[H]:{min:d.toString(),max:V.toString(),step:O.toString()}}))}}if(h.type==="customtext"||h.type.toLowerCase().includes("text")){const d=`${M}_${I}`,V=T[d]||[""];JSON.stringify(V)!==JSON.stringify(o[M]?.[I]||[""])&&x(M,I,V)}})})},[l,r,o,T,x,A,S]),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4",children:[e.jsxs("div",{className:"mb-4 border-b pb-2 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-medium text-gray-800",children:"Parameter Options"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Configure the test values for each parameter"})]}),e.jsx("button",{className:"text-gray-400 hover:text-gray-600",onClick:_,children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),l.length>0?l.map((k,M)=>{const q=k.widgets||{},J=Object.values(q),h=k.id;return e.jsxs("div",{className:"border rounded-md mb-4 overflow-hidden",children:[e.jsxs("div",{className:"bg-gray-50 px-3 py-2 text-xs font-medium text-gray-700 border-b flex justify-between items-center",children:[e.jsxs("span",{children:[k.type," (ID: ",h,")"]}),e.jsx("button",{className:"text-gray-400 hover:text-gray-600",onClick:I=>_(I,M),children:e.jsx("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsx("div",{className:"p-4 space-y-4",children:J.map((I,Y)=>{const d=I.name;if(!r[d])return null;const V=`${h}_${d}`;if(I.type==="customtext"||I.type.toLowerCase().includes("text")){const O=T[V]||[""];return e.jsxs("div",{className:"border-b pb-3",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("label",{className:"text-xs font-medium text-gray-700",children:[d,":"]}),e.jsxs("button",{className:"px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs flex items-center hover:bg-blue-200 transition-colors",onClick:()=>w(h,d),children:[e.jsx("svg",{className:"w-3 h-3 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"})}),"AI Writing"]})]}),e.jsx("div",{className:"space-y-2",children:O.map((C,B)=>e.jsxs("div",{className:"flex items-start",children:[e.jsx("textarea",{className:`flex-1 border ${C?"border-gray-300":"border-red-500"} rounded p-2 text-xs resize-y`,rows:2,placeholder:"Enter text...",value:C,onChange:H=>D(h,d,B,H.target.value),required:!0}),e.jsx("button",{className:"ml-2 text-red-500 hover:text-red-700",onClick:()=>v(h,d,B),title:"Remove",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]},B))}),e.jsxs("button",{className:"mt-2 px-2 py-1 border border-dashed border-gray-300 rounded text-xs text-gray-600 hover:bg-gray-50 flex items-center",onClick:()=>R(h,d),children:[e.jsx("svg",{className:"w-3 h-3 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})}),"Add Text"]})]},Y)}if(I.type==="number"){const O=I.options?.min||0,C=I.options?.max||100,B=(I.options?.step||10)/10,H=I.options?.precision||0,p=S(O,C,B,H),U=F[V]||{min:O.toString(),max:C.toString(),step:B.toString()};return e.jsxs("div",{className:"border-b pb-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("label",{className:"text-xs font-medium text-gray-700",children:[d,":"]}),e.jsx("div",{className:"w-4"})]}),e.jsxs("div",{className:"flex space-x-2 items-center",children:[e.jsx("label",{className:"text-xs text-gray-600",children:"Min"}),e.jsx("input",{type:"text",className:"w-12 h-6 border border-gray-300 rounded text-xs px-2",value:U.min,required:!0,onClick:N=>{N.preventDefault(),N.stopPropagation()},onChange:N=>{N.preventDefault(),N.stopPropagation();const E=N.target.value;if(A(W=>({...W,[V]:{...W[V],min:E}})),E===""||!isNaN(parseFloat(E))){const W=E===""?0:parseFloat(E),z=parseFloat(U.max||C.toString()),Q=parseFloat(U.step||B.toString()),K=S(W,z,Q,H);x(h,d,K)}}}),e.jsx("label",{className:"text-xs text-gray-600",children:"Max"}),e.jsx("input",{type:"text",className:"w-12 h-6 border border-gray-300 rounded text-xs px-2",value:U.max,onClick:N=>{N.preventDefault(),N.stopPropagation()},required:!0,onChange:N=>{N.preventDefault(),N.stopPropagation();const E=N.target.value;if(A(W=>({...W,[V]:{...W[V],max:E}})),E===""||!isNaN(parseFloat(E))){const W=parseFloat(U.min||O.toString()),z=E===""?W:parseFloat(E),Q=parseFloat(U.step||B.toString()),K=S(W,z,Q,H);x(h,d,K)}}}),e.jsx("label",{className:"text-xs text-gray-600",children:"Step"}),e.jsx("input",{type:"text",className:"w-12 h-6 border border-gray-300 rounded text-xs px-2",value:U.step,required:!0,onClick:N=>{N.preventDefault(),N.stopPropagation()},onChange:N=>{N.preventDefault(),N.stopPropagation();const E=N.target.value;if(A(W=>({...W,[V]:{...W[V],step:E}})),E===""||!isNaN(parseFloat(E))&&parseFloat(E)>0){const W=parseFloat(U.min||O.toString()),z=parseFloat(U.max||C.toString()),Q=E===""?1:parseFloat(E),K=S(W,z,Q,H);x(h,d,K)}}})]}),e.jsxs("div",{className:"mt-1",children:[e.jsx("label",{className:"text-xs text-gray-600",children:"Test values"}),e.jsx("div",{className:"mt-1 flex flex-wrap gap-1",children:(()=>{const N=o[h]?.[d]||p;if(N.length<=10)return N.map((E,W)=>e.jsxs("div",{className:"px-2 py-0.5 bg-blue-100 text-blue-800 rounded-md flex items-center text-xs cursor-pointer hover:bg-blue-200",onClick:z=>{z.stopPropagation(),c(h,d,E,z)},children:[e.jsx("span",{children:E}),e.jsx("svg",{className:"w-4 h-4 ml-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})]},W));{const E=N.slice(0,5),W=N.slice(N.length-5);return e.jsxs(e.Fragment,{children:[E.map((z,Q)=>e.jsxs("div",{className:"px-2 py-0.5 bg-blue-100 text-blue-800 rounded-md flex items-center text-xs cursor-pointer hover:bg-blue-200",onClick:K=>{K.stopPropagation(),c(h,d,z,K)},children:[e.jsx("span",{children:z}),e.jsx("svg",{className:"w-4 h-4 ml-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})]},`first-${Q}`)),e.jsx("div",{className:"px-2 py-0.5 bg-gray-100 text-gray-600 rounded-md flex items-center text-xs",children:"..."}),W.map((z,Q)=>e.jsxs("div",{className:"px-2 py-0.5 bg-blue-100 text-blue-800 rounded-md flex items-center text-xs cursor-pointer hover:bg-blue-200",onClick:K=>{K.stopPropagation(),c(h,d,z,K)},children:[e.jsx("span",{children:z}),e.jsx("svg",{className:"w-4 h-4 ml-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})]},`last-${Q}`))]})}})()})]}),e.jsx("div",{className:"mt-1",children:e.jsx("p",{className:"text-xs text-gray-500",children:"Values are distributed evenly between Min and Max"})})]},Y)}else if(I.type==="combo"){const O=I.options?.values||[],C=`${h}_${d}`,B=p=>typeof p=="string"?p:p&&typeof p=="object"&&"name"in p?p.name:String(p),H=p=>typeof p=="object"&&p!==null&&"name"in p?p.name:p;return e.jsxs("div",{className:"border-b pb-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("label",{className:"text-xs font-medium text-gray-700",children:d}),e.jsxs("div",{className:"relative dropdown-container",children:[e.jsxs("button",{className:`appearance-none border ${(o[h]?.[d]||[]).length===0?"border-red-500":"border-gray-300"} rounded px-2 py-0.5 pr-6 text-xs flex items-center bg-white text-gray-700`,onClick:p=>{p.preventDefault(),p.stopPropagation(),g(h,d,p)},"data-dropdown":C,children:[e.jsx("span",{children:(o[h]?.[d]||[]).length>0?`${d}: ${(o[h]?.[d]||[]).length} selected`:`Select ${d}`}),e.jsx("div",{className:"ml-2",children:e.jsx("svg",{className:"fill-current h-4 w-4",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",children:e.jsx("path",{d:"M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"})})})]}),u[C]&&e.jsxs("div",{className:"absolute z-[9999] mt-1 w-64 bg-white border border-gray-300 rounded-md shadow-lg dropdown-menu",style:{position:"fixed",top:typeof u[C]=="object"?`${u[C].y}px`:"0px",left:typeof u[C]=="object"?`${u[C].x}px`:"0px",maxHeight:"300px",overflowY:"auto"},children:[e.jsx("div",{className:"p-2 border-b sticky top-0 bg-white",children:e.jsx("input",{type:"text",className:"w-full px-2 py-0.5 text-xs border border-gray-300 rounded",placeholder:"Search...",value:m[C]||"",onChange:p=>{p.preventDefault(),p.stopPropagation(),b(h,d,p.target.value)},onClick:p=>{p.preventDefault(),p.stopPropagation()},autoFocus:!0})}),e.jsxs("div",{className:"px-3 py-1.5 bg-gray-50 border-b cursor-pointer text-xs flex items-center text-gray-700 hover:bg-gray-100",onClick:p=>{p.preventDefault(),p.stopPropagation();const N=O.filter(E=>!m[C]||B(E).toLowerCase().includes((m[C]||"").toLowerCase())).map(H);P(h,d,N)},children:[e.jsx("div",{className:`w-4 h-4 mr-2 border rounded-sm flex items-center justify-center ${O.length>0&&(o[h]?.[d]||[]).length===O.length?"bg-blue-500 border-blue-500":(o[h]?.[d]||[]).length>0?"bg-blue-500 border-blue-500 opacity-50":"border-gray-300"}`,children:(o[h]?.[d]||[]).length>0&&e.jsx("svg",{className:"w-3 h-3 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),e.jsx("span",{className:"font-medium",children:O.length>0&&(o[h]?.[d]||[]).length===O.length?"Deselect All":"Select All"})]}),e.jsxs("div",{className:"max-h-60 overflow-y-auto",children:[O.filter(p=>!m[C]||B(p).toLowerCase().includes((m[C]||"").toLowerCase())).map((p,U)=>e.jsxs("div",{className:"px-3 py-1.5 hover:bg-gray-100 cursor-pointer text-xs flex items-center text-gray-700",onClick:N=>{N.preventDefault(),N.stopPropagation(),c(h,d,H(p),N)},children:[e.jsx("div",{className:`w-4 h-4 mr-2 border rounded-sm flex items-center justify-center ${(o[h]?.[d]||[]).includes(H(p))?"bg-blue-500 border-blue-500":"border-gray-300"}`,children:(o[h]?.[d]||[]).includes(H(p))&&e.jsx("svg",{className:"w-3 h-3 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),e.jsx("span",{className:"whitespace-normal overflow-hidden text-ellipsis",children:B(p)})]},U)),O.filter(p=>!m[C]||B(p).toLowerCase().includes((m[C]||"").toLowerCase())).length===0&&e.jsx("div",{className:"px-3 py-4 text-sm text-gray-500 text-center",children:"No matching options"})]})]})]})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("label",{className:"text-xs text-gray-600",children:"Test values"}),(o[h]?.[d]||[]).length===0&&e.jsx("div",{className:"text-xs text-red-500 mt-1",children:"Please select at least one value"}),e.jsx("div",{className:"mt-1 flex flex-wrap gap-1",children:(o[h]?.[d]||[]).map((p,U)=>e.jsxs("div",{className:"px-2 py-0.5 bg-blue-100 text-blue-800 rounded-md flex items-center text-xs",children:[e.jsx("span",{children:p}),e.jsx("svg",{className:"w-4 h-4 ml-1 cursor-pointer hover:text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",onClick:N=>{N.preventDefault(),N.stopPropagation(),c(h,d,p,N)},children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})]},U))})]})]},Y)}else return e.jsxs("div",{className:"border-b pb-3",children:[e.jsx("div",{className:"flex justify-between items-center",children:e.jsx("label",{className:"text-xs font-medium text-gray-700",children:d})}),e.jsxs("div",{className:"mt-2",children:[e.jsx("label",{className:"text-xs text-gray-600",children:"Test values"}),e.jsxs("div",{className:"mt-1 flex flex-wrap gap-1",children:[(o[h]?.[d]||[]).map((O,C)=>e.jsxs("div",{className:"px-2 py-0.5 bg-blue-100 text-blue-800 rounded-md flex items-center text-xs",children:[e.jsx("span",{children:O}),e.jsx("svg",{className:"w-4 h-4 ml-1 cursor-pointer hover:text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",onClick:B=>{B.preventDefault(),B.stopPropagation(),c(h,d,O,B)},children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})]},C)),e.jsxs("button",{className:"px-2 py-0.5 border border-dashed border-blue-300 text-blue-600 rounded-md text-xs flex items-center hover:bg-blue-50",onClick:O=>{O.preventDefault(),O.stopPropagation();const C=`${d}${(o[h]?.[d]||[]).length+1}`;x(h,d,[...o[h]?.[d]||[],C])},children:[e.jsx("svg",{className:"w-4 h-4 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})}),e.jsx("span",{children:"Add"})]})]})]})]},Y)})})]},M)}):e.jsx("div",{className:"border rounded-md mb-4 p-4 text-center text-gray-500",children:"No nodes selected. Please select a node in the workflow to configure parameters."}),e.jsxs("div",{className:"mt-6 flex justify-between",children:[e.jsx("button",{onClick:k=>$(k),className:"px-3 py-1.5 text-xs bg-gray-100 text-gray-800 rounded-md hover:bg-gray-200 transition-colors",children:"Previous"}),e.jsx("button",{onClick:k=>L(k),className:"px-3 py-1.5 text-xs bg-pink-200 text-pink-700 rounded-md hover:bg-pink-300 transition-colors",children:"Next"})]})]})},ct=({selectedNodes:l,paramTestValues:o,selectedParams:r,totalCount:x,errorMessage:g,handlePrevious:u,handleStartGeneration:c,handleClose:m})=>{const[b,P]=y.useState([]),[L,$]=y.useState(null),[_,F]=y.useState(!1);Ie();const A=()=>{const D=Object.values(Z.graph._nodes_by_id),R=[],v=[];for(const S of D)S.type==="SaveImage"?R.push(S.id):S.type==="PreviewImage"&&v.push(S.id);const w=[...R,...v];P(w),w.length===1?$(w[0]):w.length>1&&(F(!0),$(null))};y.useEffect(()=>{A()},[]),y.useEffect(()=>{const D=()=>{if(!Z.canvas.selected_nodes)return;const R=Object.values(Z.canvas.selected_nodes);if(R.length===0)return;const v=R[0];v&&(v.type==="SaveImage"||v.type==="PreviewImage")&&(console.log("Selected image node:",v.id),$(v.id))};return document.addEventListener("click",D),()=>{document.removeEventListener("click",D)}},[]);const T=D=>{if(D&&(D.preventDefault(),D.stopPropagation()),b.length>1&&!L){F(!0);return}c(D,L||void 0)};return e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4",children:[e.jsxs("div",{className:"mb-4 border-b pb-2 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-medium text-gray-800",children:"Confirm Test Configuration"}),e.jsxs("p",{className:"text-xs text-gray-500",children:["In the selected parameter combinations, there are ",x," total runs. Each run will generate a separate image."]})]}),e.jsx("button",{className:"text-gray-400 hover:text-gray-600",onClick:m,children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),_&&b.length>1&&e.jsx("div",{className:"mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md text-amber-600 text-xs",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("div",{className:"flex-shrink-0 mt-0.5",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})})}),e.jsx("div",{className:"ml-2",children:L===null?`Multiple SaveImage and PreviewImage nodes detected with IDs ${b.join(",")}. Please click the node on canvas.`:`Current node ID is ${L}, please click Start Generation again`})]})}),g&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-md text-red-600 text-xs",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("div",{className:"flex-shrink-0 mt-0.5",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})})}),e.jsx("div",{className:"ml-2",children:g})]})}),l.length>0?l.map((D,R)=>{const v=D.type||"Unknown Node",w=D.widgets||[],S=D.id;return e.jsxs("div",{className:"border rounded-md mb-4 overflow-hidden",children:[e.jsxs("div",{className:"bg-gray-50 px-3 py-2 text-xs font-medium text-gray-700 border-b",children:[v," (ID: ",S,")"]}),e.jsx("div",{className:"p-4 space-y-3",children:w.map((k,M)=>{const q=k.name;if(!r[q])return null;const J=o[S]?.[q]||[],h=Array.isArray(J)?`[${J.join(", ")}]`:JSON.stringify(J);return e.jsxs("div",{className:M<w.length-1?"flex justify-between items-center border-b pb-2":"flex justify-between items-center",children:[e.jsx("label",{className:"font-medium text-gray-700 text-xs",children:q}),e.jsx("div",{className:"flex space-x-2 items-center",children:e.jsx("input",{type:"text",className:"w-64 h-7 border border-gray-300 rounded text-xs px-2 bg-gray-50 cursor-not-allowed text-gray-500",readOnly:!0,disabled:!0,value:h,onClick:I=>I.preventDefault()})})]},M)})})]},R)}):e.jsx("div",{className:"border rounded-md mb-4 p-4 text-center text-gray-500 text-xs",children:"No nodes selected. Please select a node in the workflow to configure parameters."}),e.jsxs("div",{className:"mt-6 flex justify-between",children:[e.jsx("button",{onClick:D=>u(D),className:"px-3 py-1.5 text-xs bg-gray-100 text-gray-800 rounded-md hover:bg-gray-200 transition-colors",children:"Previous"}),e.jsx("button",{onClick:D=>T(D),className:`px-3 py-1.5 text-xs rounded-md transition-colors ${b.length>1&&!L?"bg-gray-200 text-gray-500 cursor-not-allowed":"bg-pink-200 text-pink-700 hover:bg-pink-300"}`,disabled:b.length>1&&!L,children:"Start Generation"})]})]})},dt=({selectedNodes:l,paramTestValues:o,selectedParams:r,totalCount:x,completedCount:g,errorMessage:u,handleClose:c,setIsProcessing:m,setCurrentScreen:b,cleanupPolling:P})=>{const L=$=>{$.preventDefault(),$.stopPropagation(),Ze({clear:!0}),et(),P&&P(),m(!1),b(2)};return e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4 relative",children:[e.jsx("div",{className:"absolute inset-0 bg-gray-500 bg-opacity-30 flex flex-col items-center justify-center z-10",children:e.jsxs("div",{className:"text-center text-gray-800 bg-white p-4 rounded-lg shadow-lg",children:[e.jsx("div",{className:"mb-2 text-sm font-medium",children:"Processing..."}),e.jsxs("div",{className:"text-xs mb-3",children:["Completed ",g," of ",x," runs"]}),e.jsx("div",{className:"w-48 h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-pink-500 transition-all duration-200",style:{width:`${g/x*100}%`}})}),e.jsxs("div",{className:"mt-2 text-xs text-gray-600",children:["Already generated ",g," images"]}),e.jsx("button",{onClick:L,className:"mt-4 px-3 py-1.5 text-xs bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors",children:"Cancel"})]})}),e.jsxs("div",{className:"mb-4 border-b pb-2 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-medium text-gray-800",children:"Confirm Test Configuration"}),e.jsxs("p",{className:"text-xs text-gray-500",children:["In the selected parameter combinations, there are ",x," total runs. Each run will generate a separate image."]})]}),e.jsx("button",{className:"text-gray-400 hover:text-gray-600",onClick:c,children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),u&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-md text-red-600 text-xs",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("div",{className:"flex-shrink-0 mt-0.5",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})})}),e.jsx("div",{className:"ml-2",children:u})]})}),l.length>0?l.map(($,_)=>{const F=$.type||"Unknown Node",A=$.widgets||[],T=$.id;return e.jsxs("div",{className:"border rounded-md mb-4 overflow-hidden",children:[e.jsxs("div",{className:"bg-gray-50 px-3 py-2 text-xs font-medium text-gray-700 border-b",children:[F," (ID: ",T,")"]}),e.jsx("div",{className:"p-4 space-y-3",children:A.map((D,R)=>{const v=D.name;if(!r[v])return null;const w=o[T]?.[v]||[],S=Array.isArray(w)?`[${w.join(", ")}]`:JSON.stringify(w);return e.jsxs("div",{className:R<A.length-1?"flex justify-between items-center border-b pb-2":"flex justify-between items-center",children:[e.jsx("label",{className:"font-medium text-gray-700",children:v}),e.jsx("div",{className:"flex space-x-2 items-center",children:e.jsx("input",{type:"text",className:"w-64 h-7 border border-gray-300 rounded text-sm px-2 bg-gray-50 cursor-not-allowed text-gray-500",readOnly:!0,disabled:!0,value:S,onClick:k=>k.preventDefault()})})]},R)})})]},_)}):e.jsx("div",{className:"border rounded-md mb-4 p-4 text-center text-gray-500",children:"No nodes selected. Please select a node in the workflow to configure parameters."})]})},xt=({generatedImages:l,selectedImageIndex:o,handleSelectImage:r,handleApplySelected:x,handlePrevious:g,handleClose:u,currentPage:c,handlePageChange:m,imagesPerPage:b,notificationVisible:P,modalVisible:L,modalImageUrl:$,openImageModal:_,closeImageModal:F})=>{const A=Math.ceil(l.length/b),T=(c-1)*b,D=Math.min(T+b,l.length),R=l.slice(T,D);return e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4",children:[e.jsxs("div",{className:"mb-4 border-b pb-2 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-medium text-gray-800",children:"Generation Complete"}),e.jsxs("p",{className:"text-xs text-gray-500",children:["All ",l.length," images have been generated."]})]}),e.jsx("button",{className:"text-gray-400 hover:text-gray-600",onClick:u,children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),P&&e.jsx("div",{className:"fixed top-4 right-4 bg-green-100 border-l-4 border-green-500 text-green-700 p-3 shadow-md rounded animate-fade-in-out z-50",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"py-1",children:e.jsx("svg",{className:"h-4 w-4 text-green-500 mr-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),e.jsx("p",{className:"text-xs",children:"Parameters has been applied."})]})}),L&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50",onClick:F,children:e.jsxs("div",{className:"bg-white rounded-lg p-2 max-w-4xl max-h-[90vh] relative",onClick:v=>v.stopPropagation(),children:[e.jsx("button",{className:"absolute top-2 right-2 text-gray-700 hover:text-gray-900 rounded-full hover:bg-gray-200 p-1",onClick:F,children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),e.jsx("div",{className:"overflow-auto max-h-[calc(90vh-4rem)]",children:e.jsx("img",{src:$,alt:"Enlarged image",className:"max-w-full h-auto"})})]})}),e.jsx("div",{className:"grid grid-cols-3 gap-4 mb-6",children:R.map((v,w)=>{const S=T+w;return e.jsxs("div",{className:`relative rounded-lg overflow-hidden border ${o===S?"border-pink-500 ring-2 ring-pink-300":"border-gray-200"}`,onClick:k=>r(S,k),children:[e.jsx("button",{className:"absolute top-2 right-2 bg-white bg-opacity-75 rounded-full p-0.5 text-gray-600 hover:text-gray-900 shadow-sm z-10",onClick:k=>_(v.url,k),children:e.jsx("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"})})}),e.jsx("div",{className:"aspect-square",children:e.jsx("img",{src:v.url,alt:`Generated image ${S+1}`,className:"w-full h-full object-cover"})}),e.jsx("div",{className:"p-2 text-xs text-gray-600 bg-white max-h-16 overflow-y-auto",children:Object.entries(v.params).filter(([k,M])=>k!=="nodeParams"&&typeof M!="object").map(([k,M])=>e.jsxs("div",{children:[k,": ",String(M)]},k))})]},S)})}),A>1&&e.jsxs("div",{className:"flex justify-center items-center space-x-2 mt-4 mb-4",children:[e.jsx("button",{onClick:v=>m(1,v),disabled:c===1,className:`px-2 py-1 rounded ${c===1?"text-gray-400 cursor-not-allowed":"text-gray-700 hover:bg-gray-100"}`,children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:[e.jsx("path",{fillRule:"evenodd",d:"M15.707 15.707a1 1 0 01-1.414 0l-5-5a1 1 0 010-1.414l5-5a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 010 1.414z",clipRule:"evenodd"}),e.jsx("path",{fillRule:"evenodd",d:"M8.707 15.707a1 1 0 01-1.414 0l-5-5a1 1 0 010-1.414l5-5a1 1 0 111.414 1.414L4.414 10l4.293 4.293a1 1 0 010 1.414z",clipRule:"evenodd"})]})}),e.jsx("button",{onClick:v=>m(c-1,v),disabled:c===1,className:`px-2 py-1 rounded ${c===1?"text-gray-400 cursor-not-allowed":"text-gray-700 hover:bg-gray-100"}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z",clipRule:"evenodd"})})}),e.jsxs("div",{className:"px-2 py-1 text-xs text-gray-800",children:["Page ",c," of ",A]}),e.jsx("button",{onClick:v=>m(c+1,v),disabled:c===A,className:`px-2 py-1 rounded ${c===A?"text-gray-400 cursor-not-allowed":"text-gray-700 hover:bg-gray-100"}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z",clipRule:"evenodd"})})}),e.jsx("button",{onClick:v=>m(A,v),disabled:c===A,className:`px-2 py-1 rounded ${c===A?"text-gray-400 cursor-not-allowed":"text-gray-700 hover:bg-gray-100"}`,children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:[e.jsx("path",{fillRule:"evenodd",d:"M4.293 15.707a1 1 0 001.414 0l5-5a1 1 0 000-1.414l-5-5a1 1 0 00-1.414 1.414L8.586 10 4.293 14.293a1 1 0 000 1.414z",clipRule:"evenodd"}),e.jsx("path",{fillRule:"evenodd",d:"M11.293 15.707a1 1 0 001.414 0l5-5a1 1 0 000-1.414l-5-5a1 1 0 00-1.414 1.414L15.586 10l-4.293 4.293a1 1 0 000 1.414z",clipRule:"evenodd"})]})})]}),e.jsxs("div",{className:"mt-6 flex justify-between",children:[e.jsx("button",{onClick:v=>g(v),className:"px-3 py-1.5 text-xs bg-gray-100 text-gray-800 rounded-md hover:bg-gray-200 transition-colors",children:"Previous"}),e.jsx("button",{onClick:v=>x(v),className:"px-3 py-1.5 text-xs bg-pink-200 text-pink-700 rounded-md hover:bg-pink-300 transition-colors",disabled:o===null,children:"Apply Selected"})]})]})},ut=({visible:l,aiWritingModalText:o,setAiWritingModalText:r,aiGeneratedTexts:x,aiSelectedTexts:g,aiWritingLoading:u,aiWritingError:c,handleAiWriting:m,toggleTextSelection:b,addSelectedTexts:P,onClose:L})=>l?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg w-full max-w-2xl max-h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b flex justify-between items-center",children:[e.jsx("h3",{className:"text-lg font-medium",children:"AI Writing Assistant"}),e.jsx("button",{className:"text-gray-400 hover:text-gray-600",onClick:L,children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsxs("div",{className:"p-4 overflow-y-auto flex-1",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"Enter text and AI will generate variations"}),e.jsx("textarea",{className:"w-full border border-gray-300 rounded-md p-2 text-sm",rows:3,placeholder:"Enter some text here...",value:o,onChange:$=>r($.target.value)}),e.jsx("button",{className:"mt-2 px-4 py-2 bg-blue-100 text-blue-700 rounded-md text-sm flex items-center hover:bg-blue-200 transition-colors",onClick:m,disabled:u,children:u?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{className:"animate-spin -ml-1 mr-2 h-4 w-4 text-blue-700",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Generating..."]}):e.jsx(e.Fragment,{children:"Generate"})})]}),c&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-md text-red-600 text-sm",children:c}),x.length>0&&e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-sm font-medium mb-2",children:"Generated variations (select items to add):"}),e.jsx("div",{className:"space-y-2 max-h-[40vh] overflow-y-auto p-2",children:x.map(($,_)=>e.jsxs("div",{className:"flex items-start border border-gray-200 rounded-md p-2",children:[e.jsx("div",{className:"mr-2 mt-1",children:e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"checkbox",id:`text${_+1}`,checked:!!g[`text${_+1}`],onChange:()=>b(`text${_+1}`),className:"sr-only"}),e.jsx("div",{className:`h-4 w-4 rounded border ${g[`text${_+1}`]?"bg-blue-600 border-blue-600":"bg-white border-gray-300"} flex items-center justify-center`,onClick:()=>b(`text${_+1}`),children:g[`text${_+1}`]&&e.jsx("svg",{className:"h-3 w-3 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})})]})}),e.jsx("label",{htmlFor:`text${_+1}`,className:"text-sm text-gray-700 cursor-pointer flex-1",children:$})]},_))})]})]}),e.jsxs("div",{className:"p-4 border-t flex justify-end flex-shrink-0",children:[e.jsx("button",{className:"px-4 py-2 bg-gray-100 text-gray-700 rounded-md text-sm mr-2 hover:bg-gray-200 transition-colors",onClick:L,children:"Cancel"}),e.jsx("button",{className:"px-4 py-2 bg-blue-500 text-white rounded-md text-sm hover:bg-blue-600 transition-colors",onClick:P,disabled:Object.values(g).every($=>!$),children:"Add Selected"})]})]})}):null,ye=l=>{const o=[],r={};if(Object.keys(l).forEach(u=>{const c=parseInt(u),m=l[u]||{},b=Object.keys(m).filter(L=>m[L]&&m[L].length>0);if(b.length===0)return;const P=[[]];b.forEach(L=>{const $=m[L],_=[];P.forEach(F=>{$.forEach(A=>{const T=[...F,{nodeId:c,paramName:L,paramValue:String(A)}];_.push(T)})}),P.length=0,P.push(..._)}),r[u]=P}),Object.keys(r).length===0)return o;if(Object.keys(r).length===1){const u=Object.keys(r)[0];return r[u]}const x=Object.keys(r);let g=r[x[0]];for(let u=1;u<x.length;u++){const c=r[x[u]],m=[];g.forEach(b=>{c.forEach(P=>{m.push([...b,...P])})}),g=m}return g},mt=(l,o)=>{const r={};r.nodeParams={};const x=ye(l);return o<x.length&&x[o].forEach(u=>{const c=u.nodeId.toString(),m=u.paramName,b=u.paramValue;r.nodeParams[c]||(r.nodeParams[c]={}),r.nodeParams[c][m]=b,r[m]=b}),r},ht=`
  @keyframes highlight-pulse {
    0% { 
      box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5);
    }
    70% { 
      box-shadow: 0 0 0 15px rgba(59, 130, 246, 0);
    }
    100% { 
      box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
    }
  }
  
  .highlight-pulse {
    animation: highlight-pulse 1.5s infinite;
    border: 2px solid #3b82f6;
  }

  @keyframes fade-in-out {
    0% { opacity: 0; transform: translateY(-20px); }
    10% { opacity: 1; transform: translateY(0); }
    90% { opacity: 1; transform: translateY(0); }
    100% { opacity: 0; transform: translateY(-20px); }
  }
  
  .animate-fade-in-out {
    animation: fade-in-out 3s forwards;
  }
`,vt=({selectedNodes:l,visible:o,onClose:r})=>{const[x,g]=y.useState(0),[u,c]=y.useState({Steps:!0,CFG:!0,sampler_name:!0,threshold:!1,prompt:!1}),[m,b]=y.useState(!1),[P,L]=y.useState(!1),[$,_]=y.useState(0),[F,A]=y.useState(12),[T,D]=y.useState(null),[R,v]=y.useState(()=>Array(12).fill(null).map((t,s)=>({url:`https://source.unsplash.com/random/300x300?sig=${Math.random()}`,params:{step:s%3===0?5:s%3===1?10:15,sampler_name:"euler",cfg:1}}))),[w,S]=y.useState({}),[k,M]=y.useState({}),[q,J]=y.useState({}),[h,I]=y.useState({}),[Y,d]=y.useState(1),V=6,[O,C]=y.useState(null),[B,H]=y.useState(!1),[p,U]=y.useState(!1),[N,E]=y.useState(""),[W,z]=y.useState({}),[Q,K]=y.useState(!1),[pe,ge]=y.useState(""),[ve,de]=y.useState([]),[Ee,xe]=y.useState(!1),[we,Ne]=y.useState(""),[ke,Ce]=y.useState(""),[$e,ne]=y.useState(null),[Se,oe]=y.useState({}),{dispatch:ae}=Ie(),ue=y.useRef(null),le=y.useRef(null),We=async()=>{if(!pe.trim()){ne("Please enter some text to generate variations");return}xe(!0),ne(null),de([]),oe({});try{const t=await Pe.generateSDPrompts(pe);de(t);const s={};t.forEach((i,n)=>{s[`text${n+1}`]=!1}),oe(s)}catch(t){console.error("Error generating text:",t),ne("Failed to generate text variations. Please try again.")}finally{xe(!1)}},_e=(t,s,i,n)=>{const a=`${t}_${s}`;z(j=>{const G=[...j[a]||[]];return G[i]=n,{...j,[a]:G}});const f=[...W[a]||[]];f[i]=n,te(t,s,f)},De=(t,s)=>{const i=`${t}_${s}`;z(a=>{const f=[...a[i]||[]];return f.push(""),{...a,[i]:f}});const n=[...W[i]||[],""];te(t,s,n)},Oe=(t,s,i)=>{const n=`${t}_${s}`;z(f=>{const j=[...f[n]||[]];return j.splice(i,1),{...f,[n]:j}});const a=[...W[n]||[]];a.splice(i,1),te(t,s,a)},Ae=t=>{oe(s=>({...s,[t]:!s[t]}))},Be=()=>{const t=`${we}_${ke}`,s=Object.entries(Se).filter(([n,a])=>a).map(([n])=>{const a=parseInt(n.replace("text",""))-1;return ve[a]});if(s.length===0)return;z(n=>{const a=[...n[t]||[]];return{...n,[t]:[...a,...s]}});const i=[...W[t]||[],...s];te(we,ke,i),K(!1)},Te=(t,s)=>{K(!0),Ne(t),Ce(s),ge(""),de([]),oe({}),xe(!1),ne(null)};y.useEffect(()=>{if(!l||l.length===0)return;const t={...w},s=l.map(n=>n.id.toString());Object.keys(t).forEach(n=>{s.includes(n)||delete t[n]}),l.forEach(n=>{const a=n.id.toString();t[a]||(t[a]={})}),JSON.stringify(t)!==JSON.stringify(w)&&S(t)},[l,w]),y.useEffect(()=>{ae({type:"SET_SCREEN_STATE",payload:{currentScreen:x,isProcessing:m,isCompleted:P}})},[x,m,P,ae]),y.useEffect(()=>{const t=document.createElement("style");return t.textContent=ht,document.head.appendChild(t),()=>{document.head.removeChild(t)}},[]),y.useEffect(()=>{const t=s=>{if(Object.values(k).some(i=>i)){const i=s.target,n=!!i.closest(".dropdown-menu"),a=!!i.closest("[data-dropdown]");!n&&!a&&M({})}};return document.addEventListener("mousedown",t),()=>{document.removeEventListener("mousedown",t)}},[k]);const Le=t=>{if(t&&(t.preventDefault(),t.stopPropagation()),x===0){const s={...w};Object.keys(s).forEach(i=>{const n=s[i];Object.keys(n).forEach(a=>{u[a]||delete n[a]})}),S(s)}if(x===1){const s={...w};l.forEach(n=>{const a=n.id.toString(),f=n.widgets||{};Object.values(f).forEach(j=>{const G=j.name;if(u[G]&&(j.type==="customtext"||j.type.toLowerCase().includes("text"))){const ee=`${a}_${G}`,se=W[ee]||[""];s[a]=s[a]||{},s[a][G]=se}})}),S(s);const i=ye(s);A(i.length)}C(null),g(s=>Math.min(s+1,2))},fe=t=>{if(t&&(t.preventDefault(),t.stopPropagation()),C(null),P&&L(!1),x===1){const s=l.map(a=>a.id.toString()),i=Object.keys(w),n={...w};i.forEach(a=>{s.includes(a)||delete n[a]}),S(n)}if(x===2||P){const s={...w};Object.entries(W).forEach(([i,n])=>{if(!n||n.length===0)return;const[a,f]=i.split("_");l.some(j=>j.id.toString()===a)&&(s[a]=s[a]||{},JSON.stringify(s[a][f])!==JSON.stringify(n)&&(s[a][f]=n))}),S(s)}g(s=>Math.max(s-1,0))},Re=(t,s)=>{s&&(s.preventDefault(),s.stopPropagation());const i=u[t];if(c(n=>({...n,[t]:!i})),i){const n={...w};Object.keys(n).forEach(a=>{n[a][t]&&delete n[a][t]}),S(n)}},ze=(t,s,i)=>{i.preventDefault(),i.stopPropagation();const n=`${t}_${s}`;M(a=>{if(a[n]&&typeof a[n]=="object"?a[n].isOpen:!!a[n])return{...a,[n]:!1};{let j=0,G=0;if(i.currentTarget){const ce=i.currentTarget.getBoundingClientRect();j=ce.left,G=ce.bottom}else j=i.clientX,G=i.clientY+20;const ee=window.innerWidth,se=250;return j+se>ee&&(j=ee-se-10),j<0&&(j=10),{...a,[n]:{isOpen:!0,x:j,y:G}}}})},te=(t,s,i)=>{S(n=>{const a={...n};return a[t]||(a[t]={}),a[t][s]=i,a})},Fe=(t,s,i,n)=>{n&&(n.preventDefault(),n.stopPropagation()),S(a=>{const f={...a};f[t]||(f[t]={}),f[t][s]||(f[t][s]=[]);const j=f[t][s];return j.includes(i)?f[t][s]=j.filter(G=>G!==i):f[t][s]=[...j,i],f})},Ve=(t,s,i)=>{const n=`${t}_${s}`;J(a=>({...a,[n]:i}))},Ge=(t,s,i)=>{if(!w[t]){te(t,s,i);return}const n=w[t][s]||[];i.length===n.length?te(t,s,[]):te(t,s,[...i])},Ue=(t,s)=>{s&&(s.preventDefault(),s.stopPropagation()),d(Math.max(1,Math.min(t,Math.ceil(R.length/V))))},me=()=>{ue.current&&(clearTimeout(ue.current),ue.current=null),le.current=null};y.useEffect(()=>()=>{me()},[]);const He=async(t,s)=>{t&&(t.preventDefault(),t.stopPropagation()),me();const i=ye(w),n=i.length;if(n>100){C(`Cannot generate more than 100 images at once (currently: ${n} images)`);return}if(C(null),b(!0),_(0),console.log("Generated parameter combinations:",i),i.length===0){C("No valid parameter combinations found. Please check your parameter selections."),b(!1);return}let a=s||null;if(a===null){const j=ot();j!==null&&(a=j)}if(a===null){C("Please select a SaveImage or PreviewImage node first."),b(!1);return}const f=[];try{const j=Date.now().toString();le.current=j;for(const re of i){const X=await rt(re);X.prompt_id?f.push(X.prompt_id):(console.error("Failed to get prompt_id from response:",X),f.push(""))}const G=Array(i.length).fill(null).map((re,X)=>({url:`https://source.unsplash.com/random/300x300?sig=${Math.random()}`,params:mt(w,X)}));v(G);const ee=Date.now(),se=5*60*1e3,ce=async()=>{if(le.current!==j){console.log("Another polling session has started, stopping this one");return}if(Date.now()-ee>se){console.log("Timeout reached while waiting for images"),le.current===j&&(b(!1),L(!0),d(1));return}let re=0;for(let X=0;X<f.length;X++){const je=f[X];if(je)try{const he=await at(je,Number(a));he&&(G[X]={...G[X],url:he},re++)}catch(he){console.error(`Error fetching image for prompt ID ${je}:`,he)}}le.current===j&&(v([...G]),_(re),re===f.length?(console.log("All images ready, completing session"),b(!1),L(!0),d(1)):ue.current=setTimeout(ce,3e3))};ce()}catch(j){console.error("Error generating images:",j),b(!1)}},qe=(t,s)=>{s&&(s.preventDefault(),s.stopPropagation()),D(t)},Ke=(t,s)=>{s.preventDefault(),s.stopPropagation(),E(t),U(!0)},Je=t=>{t&&(t.preventDefault(),t.stopPropagation()),U(!1)},Ye=async t=>{if(t&&(t.preventDefault(),t.stopPropagation()),T!==null){console.log(`Applied image ${T+1} with parameters:`,R[T].params);let s=1;if(w){for(const n in w)if(w[n])for(const a in w[n]){const f=w[n][a];if(f){let j=1;Array.isArray(f)?j=f.length>0?f.length:1:typeof f=="object"&&f!==null&&(j=Object.keys(f).length>0?Object.keys(f).length:1),s=s*j}}}Pe.trackEvent({event_type:"parameter_debug_apply",message_type:"parameter_debug",message_id:tt(),data:{workflow:(await Z.graphToPrompt()).output,selected_params:R[T].params,all_params:w,count:s}});const i=R[T].params;i.nodeParams&&(Object.entries(i.nodeParams).forEach(([n,a])=>{const f=Z.graph._nodes_by_id[n];!f||!f.widgets||Object.entries(a).forEach(([j,G])=>{for(const ee of f.widgets)if(ee.name===j){ee.value=G;break}})}),Z.graph.setDirtyCanvas(!1,!0),H(!0),setTimeout(()=>{H(!1)},3e3))}},ie=(t,s)=>{if(t&&(t.preventDefault(),t.stopPropagation()),x===1&&s!==void 0){const i=[...l],n=i[s];if(i.splice(s,1),n){const a=n.id.toString();S(f=>{const j={...f};return delete j[a],j})}i.length===0?r&&(ae({type:"SET_SCREEN_STATE",payload:null}),be(),r()):ae({type:"SET_SELECTED_NODE",payload:i});return}r?(ae({type:"SET_SCREEN_STATE",payload:null}),be(),r()):be()},be=()=>{g(0),c({Steps:!0,CFG:!0,sampler_name:!0,threshold:!1,prompt:!1}),me(),b(!1),L(!1),_(0),A(12),D(null),v(Array(12).fill(null).map((t,s)=>({url:`https://source.unsplash.com/random/300x300?sig=${Math.random()}`,params:{step:s%3===0?5:s%3===1?10:15,sampler_name:"euler",cfg:1}}))),S({}),M({}),J({}),I({}),d(1),C(null),H(!1),U(!1),E(""),z({}),K(!1),ge(""),de([]),xe(!1),Ne(""),Ce(""),ne(null),oe({})};return!o||l.length===0?e.jsx("div",{className:"flex-1 flex flex-col items-center justify-center p-8 bg-gray-50 overflow-y-auto",onClick:t=>t.stopPropagation(),children:e.jsxs("div",{className:"max-w-lg p-8 bg-white rounded-lg shadow-sm border border-blue-100 relative",children:[e.jsxs("div",{className:"mb-6 text-center",children:[e.jsx("h3",{className:"text-base font-bold text-blue-800 mb-2",children:"GenLab"}),e.jsx("div",{className:"h-1 w-16 bg-blue-500 mx-auto rounded-full mb-4"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("div",{className:"bg-blue-100 p-2 rounded-full text-blue-600",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{d:"M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"})})}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-gray-800",children:"Batch Test Parameter Pairs"}),e.jsx("p",{className:"text-xs text-gray-600",children:"Select a node to batch test parameter pairs"})]})]}),e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("div",{className:"bg-indigo-100 p-2 rounded-full text-indigo-600",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z",clipRule:"evenodd"})})}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-gray-800",children:"How To Use"}),e.jsx("p",{className:"text-xs text-gray-600",children:"Click on any node in your workflow to start the parameter testing process"})]})]}),e.jsx("div",{className:"mt-6 text-center",children:e.jsx("p",{className:"text-xs text-gray-600 mb-3",children:"No node is currently selected"})})]})]})}):P?e.jsx("div",{className:"flex-1 overflow-y-auto bg-gray-50 p-4",onClick:t=>t.stopPropagation(),children:e.jsx(xt,{generatedImages:R,selectedImageIndex:T,handleSelectImage:qe,handleApplySelected:Ye,handlePrevious:fe,handleClose:ie,currentPage:Y,handlePageChange:Ue,imagesPerPage:V,notificationVisible:B,modalVisible:p,modalImageUrl:N,openImageModal:Ke,closeImageModal:Je})}):m?e.jsx("div",{className:"flex-1 overflow-y-auto bg-gray-50 p-4",onClick:t=>t.stopPropagation(),children:e.jsx(dt,{selectedNodes:l,paramTestValues:w,selectedParams:u,totalCount:F,completedCount:$,errorMessage:O,handleClose:ie,setIsProcessing:b,setCurrentScreen:g,cleanupPolling:me})}):x===0?e.jsx("div",{className:"flex-1 overflow-y-auto bg-gray-50 p-4 flex flex-col h-full max-h-[80vh]",onClick:t=>t.stopPropagation(),children:e.jsx(lt,{selectedNodes:l,handleParamSelect:Re,selectedParams:u,handleNext:Le,handleClose:ie})}):x===1?e.jsxs("div",{className:"flex-1 overflow-y-auto bg-gray-50 p-4 flex flex-col h-full max-h-[80vh]",onClick:t=>t.stopPropagation(),children:[e.jsx(it,{selectedNodes:l,paramTestValues:w,selectedParams:u,updateParamTestValues:te,toggleDropdown:ze,openDropdowns:k,handleTestValueSelect:Fe,searchTerms:q,handleSearch:Ve,handleSelectAll:Ge,handleNext:Le,handlePrevious:fe,handleClose:ie,inputValues:h,setInputValues:I,textInputs:W,handleTextInputChange:_e,handleAddTextInput:De,handleRemoveTextInput:Oe,openAiWritingModal:Te}),e.jsx(ut,{visible:Q,aiWritingModalText:pe,setAiWritingModalText:ge,aiGeneratedTexts:ve,aiSelectedTexts:Se,aiWritingLoading:Ee,aiWritingError:$e,handleAiWriting:We,toggleTextSelection:Ae,addSelectedTexts:Be,onClose:()=>K(!1)})]}):e.jsx("div",{className:"flex-1 overflow-y-auto bg-gray-50 p-4 flex flex-col h-full max-h-[80vh]",onClick:t=>t.stopPropagation(),children:e.jsx(ct,{selectedNodes:l,paramTestValues:w,selectedParams:u,totalCount:F,errorMessage:O,handlePrevious:fe,handleStartGeneration:He,handleClose:ie})})};export{vt as ParameterDebugInterface};
